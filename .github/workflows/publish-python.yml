name: Build and Publish Python Package

on:
  push:
    tags:
      - 'v*.*.*'
      - '!ts-v*.*.*'
  # release:
  #   types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    # Only run if tag matches v*.*.* pattern (not ts-v*.*.*)
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/ts-v')) ||
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v') && !startsWith(github.event.release.tag_name, 'ts-v'))

    environment:
      name: pypi-release

    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      - name: Install Python 3.13
        run: uv python install 3.13
      - name: Build
        working-directory: instagram-py
        run: uv build
      # Credentials are not needed due to trusted publisher setting
      - name: Publish
        working-directory: instagram-py
        run: uv publish
